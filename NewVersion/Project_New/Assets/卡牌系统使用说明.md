# 卡牌系统使用说明

## 系统概述

这是一个基于德州扑克规则的卡牌游戏系统，包含40张卡牌（36张基础牌、1张黑牌、3张金牌）。

---

## 📦 核心组件

### 1. **CardData.cs** - 卡牌数据（ScriptableObject）
存储单张卡牌的所有数据。

**属性：**
- `id` - 唯一编号（0-39）
- `cardType` - 卡牌类型（Basic基础/Black黑牌/Gold金牌）
- `suit` - 花色（Heart红心/Diamond方块/Club梅花/Spade黑桃/None无）
- `rank` - 点数（1-9，黑牌和金牌为0）
- `sprite` - 卡面图片
- `canBeDiscarded` - 能否被弃掉（黑牌为false）
- `canBePlayed` - 能否被打出（黑牌为false）
- `cardName` - 显示名称

---

### 2. **DeckManager.cs** - 牌堆管理器（Singleton）
管理所有卡牌的状态和分发。

**主要功能：**
- `InitializeDeck()` - 初始化牌堆并洗牌
- `DrawCard()` - 抽一张牌
- `MarkAsPlayed(card)` - 标记卡牌为已打出
- `MarkAsDiscarded(card)` - 标记卡牌为已弃掉
- `GetDeckCount()` - 获取牌堆剩余数量

**UnityEvent：**
- `OnDeckInitialized` - 牌堆初始化完成
- `OnDeckEmpty` - 牌堆已空
- `OnCardDrawn(int)` - 抽牌时触发（参数：剩余数量）

---

### 3. **CardManager.cs** - 卡牌管理器（Singleton）
处理卡牌的选中、打出、弃牌逻辑。

**主要功能：**
- `AttemptPlayCards()` - 尝试打出选中的卡牌
- `AttemptDiscardCards()` - 尝试弃掉选中的卡牌
- `GetSelectedCards()` - 获取当前选中的卡牌列表
- `DeselectAllCards()` - 取消所有选中

**UnityEvent（供您配置音效、特效、UI反馈）：**
- `OnPlaySuccess` - 出牌成功
- `OnPlayFailed` - 出牌失败（牌型不符合）
- `OnGoldCardWin` - 金牌胜利（游戏结束）
- `OnBlackCardPlayAttempt` - 尝试打出黑牌（阻止）
- `OnDiscardSuccess` - 弃牌成功
- `OnBlackCardDiscardAttempt` - 尝试弃掉黑牌（阻止）
- `OnDiscardLimitExceeded(int)` - 预留：超过弃牌上限

---

### 4. **PokerRuleEvaluator.cs** - 德扑规则判定器
判断选中的卡牌是否符合德州扑克规则。

**支持的牌型：**

| 牌数 | 有效牌型 |
|------|----------|
| 2张  | 对子 |
| 3张  | 三条、顺子 |
| 4张  | 四条、顺子 |
| 5张  | 对子、两对、三条、顺子、同花、葫芦、四条、同花顺、单张 |

**顺子范围：** 12345 ~ 56789（不循环）

---

### 5. **Card.cs** - 单张卡牌（扩展）
新增方法：
- `SetCardData(CardData)` - 设置卡牌数据并更新图片
- `ClearCard()` - 清空卡牌数据（打出/弃牌后）
- `IsEmpty()` - 检查卡牌是否为空

---

### 6. **HorizontalCardHolder.cs** - 手牌持有者（扩展）
新增方法：
- `DealCards()` - 手动发牌按钮（补充空位）

新增设置：
- `dealOnStart` - 游戏开始时自动发牌（默认true）
- `dealDelay` - 发牌延迟（默认0.1秒）

---

### 7. **DeckPreviewUI.cs** - 牌堆预览UI
显示所有40张卡牌的状态。

**功能：**
- `OpenPreview()` - 打开预览面板
- `ClosePreview()` - 关闭预览面板
- `TogglePreview()` - 切换预览面板
- `UpdateAllCardStatus()` - 更新所有卡牌的显示状态

**颜色状态：**
- 白色（正常）- 在牌堆中
- 半透明 - 在手牌中
- 灰色半透明 - 已打出/已弃掉

---

## 🛠️ 设置步骤

### 步骤1：生成CardData资源

1. 在Unity编辑器中，点击菜单：`Tools → 卡牌系统 → 生成所有CardData资源`
2. 在弹出的窗口中：
   - 确认保存路径（默认：`Assets/Scriptables/CardData`）
   - 勾选"自动匹配Sprite"（将自动从`Assets/CardSprites/`匹配图片）
3. 点击"生成所有CardData (40张)"按钮
4. 等待生成完成（会自动匹配对应的卡牌图片）

**注意：** 如果图片匹配失败，请手动在Inspector中为每个CardData设置sprite。

---

### 步骤2：场景设置

#### A. 创建DeckManager
1. 在场景中创建空物体，命名为`DeckManager`
2. 添加`DeckManager`脚本
3. 在Inspector中：
   - 将`Assets/Scriptables/CardData/`文件夹中的所有40个CardData资源拖拽到`All Cards Database`列表中
   - 配置UnityEvent（可选）

#### B. 配置CardManager
1. 找到场景中已有的`CardManager`物体
2. 在Inspector中配置：
   - `Card Move Speed` - 卡牌移动速度（默认0.5秒）
   - `Card Stay Duration` - 卡牌停留时间（默认1秒）
   - `Center Screen Offset` - 屏幕中心偏移
3. 配置UnityEvent：
   - `OnPlaySuccess` - 添加音效、特效
   - `OnGoldCardWin` - 添加游戏结束UI显示
   - `OnBlackCardPlayAttempt` - 添加提示音效
   - 等等...

#### C. 配置HorizontalCardHolder
1. 找到场景中的手牌持有者物体
2. 在Inspector中：
   - 确认`Cards To Spawn = 7`（手牌上限）
   - `Deal On Start` - 勾选（游戏开始自动发牌）
   - `Deal Delay` - 每张牌之间的延迟（默认0.1秒）

#### D. 创建UI按钮

**出牌按钮：**
- 创建Button，命名为`PlayButton`
- OnClick事件 → 拖拽`CardManager`物体 → 选择`CardManager.AttemptPlayCards()`

**弃牌按钮：**
- 创建Button，命名为`DiscardButton`
- OnClick事件 → 拖拽`CardManager`物体 → 选择`CardManager.AttemptDiscardCards()`

**发牌按钮：**
- 创建Button，命名为`DealButton`
- OnClick事件 → 拖拽`HorizontalCardHolder`物体 → 选择`HorizontalCardHolder.DealCards()`

---

### 步骤3：创建牌堆预览UI（可选）

#### A. 创建预览面板
1. 在Canvas下创建Panel，命名为`DeckPreviewPanel`
2. 设置Panel为全屏或居中大小
3. 添加关闭按钮（X按钮）

#### B. 创建Grid布局
1. 在Panel下创建空物体，命名为`CardGrid`
2. 添加`Grid Layout Group`组件：
   - Cell Size: (80, 120) - 根据卡牌图片大小调整
   - Spacing: (10, 10)
   - Constraint: Fixed Column Count = 9
   - Child Alignment: Upper Left

#### C. 创建卡牌图标预制体
1. 创建Image物体，命名为`CardIcon`
2. 调整大小（与Grid的Cell Size一致）
3. 保存为Prefab

#### D. 配置DeckPreviewUI
1. 在场景中创建空物体，命名为`DeckPreviewUI`
2. 添加`DeckPreviewUI`脚本
3. 在Inspector中：
   - `Deck Preview Panel` - 拖拽预览Panel
   - `Grid Parent` - 拖拽CardGrid物体
   - `Card Icon Prefab` - 拖拽CardIcon预制体
   - 配置颜色（可选）

#### E. 创建打开按钮
- 创建Button，命名为`OpenDeckPreviewButton`
- OnClick事件 → 拖拽`DeckPreviewUI`物体 → 选择`DeckPreviewUI.TogglePreview()`

---

## 🎮 游戏流程

1. **游戏开始**
   - DeckManager初始化牌堆（40张卡，洗牌）
   - HorizontalCardHolder自动发7张牌到手上

2. **玩家操作**
   - 点击卡牌选中/取消选中
   - 右键点击取消所有选中
   - 拖拽卡牌可调整手牌顺序

3. **出牌**
   - 选中2-5张牌
   - 点击"出牌"按钮
   - 系统判定牌型：
     - ✅ 符合规则 → 卡牌移动到中心 → 停留1秒 → 消失
     - ❌ 不符合规则 → 触发`OnPlayFailed`事件

4. **弃牌**
   - 选中任意张牌（不能包含黑牌）
   - 点击"弃牌"按钮
   - 卡牌移动到中心 → 停留1秒 → 消失

5. **发牌**
   - 点击"发牌"按钮
   - 从牌堆抽牌补充空位

6. **金牌胜利**
   - 恰好选中3张金牌
   - 点击"出牌"按钮
   - 触发`OnGoldCardWin`事件 → 显示游戏结束界面

---

## ⚠️ 特殊规则

### 黑牌
- **无法打出**：选中黑牌时点击"出牌"会触发`OnBlackCardPlayAttempt`
- **无法弃掉**：选中黑牌时点击"弃牌"会触发`OnBlackCardDiscardAttempt`
- **永久占位**：黑牌会一直占据手牌位置

### 金牌
- **特殊胜利条件**：必须恰好选中3张金牌（不能多选其他牌）
- **独立判定**：金牌胜利不受德扑规则限制

### 空slot
- 打出/弃牌后，卡牌会消失但slot保留
- 点击"发牌"按钮可补充空位

---

## 🐛 调试功能

所有核心功能都有Debug.Log输出：
- 牌堆初始化
- 抽牌/发牌
- 选中/取消选中
- 牌型判定结果
- 出牌/弃牌动画

打开Console窗口可查看详细日志。

---

## 📝 扩展建议

### 1. 添加卡牌动画
在Card.SetCardData()中添加：
```csharp
transform.DOScale(1.2f, 0.2f).SetLoops(2, LoopType.Yoyo);
```

### 2. 添加音效
在CardManager的UnityEvent中配置AudioSource.Play()

### 3. 添加特效
在打出/弃牌动画中添加粒子特效

### 4. UI优化
- 显示当前选中牌型（实时判定）
- 显示牌堆剩余数量
- 显示手牌数量

### 5. 游戏规则扩展
- 添加回合系统
- 添加分数计算
- 添加多种牌型的分数权重

---

## 📞 常见问题

**Q: 生成CardData后图片没有自动匹配？**
A: 请检查图片是否在`Assets/CardSprites/`文件夹中，且文件名符合规范（如"Heart (1).png"）。

**Q: 点击按钮没反应？**
A: 检查Scene中是否有DeckManager和CardManager物体，且脚本已添加。

**Q: 发牌后卡牌是空白的？**
A: 检查Card组件的`Card Image`字段是否已设置（拖拽卡牌上的Image组件）。

**Q: 如何修改手牌上限？**
A: 修改HorizontalCardHolder的`cardsToSpawn`值。

**Q: 如何禁用初始自动发牌？**
A: 取消勾选HorizontalCardHolder的`Deal On Start`。

---

## 📄 脚本清单

- ✅ `CardData.cs` - 卡牌数据ScriptableObject
- ✅ `DeckManager.cs` - 牌堆管理器
- ✅ `CardManager.cs` - 卡牌管理器（扩展）
- ✅ `Card.cs` - 单张卡牌（扩展）
- ✅ `PokerRuleEvaluator.cs` - 德扑规则判定器
- ✅ `HorizontalCardHolder.cs` - 手牌持有者（扩展）
- ✅ `DeckPreviewUI.cs` - 牌堆预览UI
- ✅ `CardDataGenerator.cs` - 编辑器工具

---

## 🎉 完成！

系统已完全实现，所有功能均可通过Inspector配置UnityEvent来添加自定义的表现效果。

祝开发顺利！
